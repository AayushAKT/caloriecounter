<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="style.css" />
  <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
  <link rel="shortcut icon" href="images/faivcon.png" type="image/x-icon" />

  <!-- Tailwind CDN link -->
  <script src="https://cdn.tailwindcss.com"></script>
  <title>MainPage</title>
</head>

<body>

  <!-- navbar starts here-->

  <header class="text-gray-600 body-font sticky top-0 bg-white z-50">
    <div class="container mx-auto flex flex-wrap p-5 flex-col md:flex-row items-center">
      <nav class="flex lg:w-2/5 flex-wrap items-center text-base md:ml-auto">
        <a class="mr-5 hover:text-gray-900 cursor-pointer" href="#home">Home</a>
        <a class="mr-5 hover:text-gray-900 cursor-pointer" href="#calculateCalories">Calculate Calories</a>
        <a class="mr-5 hover:text-gray-900 cursor-pointer" href="#displayTable">Table</a>
      </nav>
      <a
        class="flex order-first lg:order-none lg:w-1/5 title-font font-medium items-center text-gray-900 lg:items-center lg:justify-center mb-4 md:mb-0">
        <!-- <svg xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" class="w-10 h-10 text-white p-2 bg-green-500 rounded-full" viewBox="0 0 24 24">
            <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"></path>
          </svg> -->
        <img src="images/faivcon.png" alt="image" class="h-7">
        <span class="ml-3 text-xl">Calorie Tracker</span>
      </a>
      <div class="lg:w-2/5 inline-flex lg:justify-end ml-5 lg:ml-0">
        <a href="log-inPage.html"
          class="inline-flex items-center bg-gray-200 border-0 py-1 px-3 focus:outline-none hover: rounded text-base mt-4 md:mt-0">Log-Out
          <svg fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            class="w-4 h-4 ml-1" viewBox="0 0 24 24">
            <path d="M5 12h14M12 5l7 7-7 7"></path>
          </svg>
        </a>
      </div>
    </div>
  </header>

  <!-- navbar ends here -->

  <h1 class="text-center text-4xl mb-10 mt-10 flex align-center justify-center gap-4">
    <img src="images/me.jpg" class="h-12 inline-flex rounded-full" alt="" />
    Welcome <span style="text-transform: capitalize;">
      <%= user.user_name %>!
    </span>
  </h1>

  <!-- profile section starts here -->

  <div class="bg-white overflow-hidden shadow rounded-lg border" id="home">
    <div class="px-4 py-5 sm:px-6">
      <h3 class="text-lg leading-6 font-medium text-gray-900">
        Hello <span id="usermeal" style="text-transform: capitalize;">
          <%= user.user_name %>
        </span> !
      </h3>
      <p class="mt-1 max-w-2xl text-sm text-gray-500">
        Wishing you a fantastic day and success in your pursuit of fitness!
        Here are your details.
      </p>

      <!-- Add this button in your profile section -->
      <button id="updateDetailsBtn"
        class="text-white bg-blue-700 hover:bg-blue-800 font-medium rounded-lg text-sm px-4 py-2 mt-4">
        Update Details
      </button>

    </div>
    <div class="border-t border-gray-200 px-4 py-5 sm:p-0">
      <dl class="sm:divide-y sm:divide-gray-200">
        <div class="py-3 sm:py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
          <dt class="text-sm font-medium text-gray-500">Username</dt>
          <dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2">
            <span style="text-transform: capitalize;">
              <%= user.user_name %>
            </span>
          </dd>
        </div>
        <div class="py-3 sm:py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
          <dt class="text-sm font-medium text-gray-500">Age</dt>
          <dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2">
            <%= user.Age %>
          </dd>
        </div>
        <div class="py-3 sm:py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
          <dt class="text-sm font-medium text-gray-500">Gender</dt>
          <dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2">
            <span style="text-transform: capitalize;">
              <%= user.Gender %>
            </span>
          </dd>
        </div>
        <div class="py-3 sm:py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
          <dt class="text-sm font-medium text-gray-500">Weight</dt>
          <dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2">
            <%= user.Weight %> <span>kg</span>
          </dd>
        </div>
        <div class="py-3 sm:py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
          <dt class="text-sm font-medium text-gray-500">Height</dt>
          <dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2">
            <%= user.Height %> <span>cm</span>
          </dd>
        </div>
      </dl>
    </div>
  </div>

  <!-- profile section ends here -->


  <!-- calorie search section starts here  -->
  <div class="border-2 p-2 rounded-lg mt-10">
    <h2 class="flex align-center justify-center text-2xl font-medium p-3">
      Search Calories
    </h2>
    <form class="max-w-md mx-auto" id="calculateCalories" onsubmit="getData(); return false;">
      <div class="relative">
        <div class="absolute inset-y-0 start-0 flex items-center ps-3 pointer-events-none">
          <svg class="w-4 h-4 text-gray-500 dark:text-gray-400" aria-hidden="true" xmlns="http://www.w3.org/2000/svg"
            fill="none" viewBox="0 0 20 20">
            <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="m19 19-4-4m0-7A7 7 0 1 1 1 8a7 7 0 0 1 14 0Z" />
          </svg>
        </div>
        <input id="searchfooditem"
          class="block w-full p-4 ps-10 text-sm text-gray-900 border border-gray-300 rounded-lg bg-gray-50 focus:ring-blue-500 focus:border-blue-500 dark:white dark:border-gray-600 dark:placeholder-gray-400 dark:text-gray-900 dark:focus:ring-blue-500 dark:focus:border-blue-500"
          placeholder="Enter food or dish" required />
        <button type="button" id="calorieSearchBtn"
          class="text-white absolute end-2.5 bottom-2.5 bg-blue-700 hover:bg-blue-800 font-medium rounded-lg text-sm px-4 py-2 dark:bg-green-500 dark:hover:bg-blue-700 dark:focus:ring-blue-800">
          Search
        </button>
      </div>
    </form>

    <form action="/meal" method="POST">
      <div class="flex flex-col align-center p-5">
        <p class="p-2">
          <input id="foodItemName" name="meal_name" class="text-2xl outline-none" value="Food Item"></input>
        </p>
    
        <p class="p-2">Name:<input id="user_name" name="user_name" class="outline-none"></input></p>
        <p class="p-2">Calories(kcal): <input id="calorie" value="0.00" name="calorie"
            class="w-[5rem] outline-none"></input></p>
        <p class="p-2">Protien(g): <input id="protein" value="0.00" name="protein" class="w-[5rem] outline-none"></input>
        </p>
        <div class="mx-1">
          <div class="mx-1">
            <button type="submit" id="enterDataBtn" onclick="validateForm()"
              class="text-white end-2.5 bottom-2.5 bg-blue-700 hover:bg-blue-800 font-medium rounded-lg text-sm px-4 py-2 dark:bg-green-500 dark:hover:bg-blue-700 dark:focus:ring-blue-800">
              Enter
            </button>
          </div>
        </div>
      </div>
    </form>
  </div>
  <!-- calorie search section ends here -->

  <!-- table starts here -->

  <div class="relative overflow-x-auto border-2 p-2 rounded-lg mt-10">

    <div class="mb-4 w-[10rem]">
      <label for="datepicker" class="block text-sm font-medium text-gray-700">Select Date:</label>
      <input id="datepicker" name="selectedDate" type="date" class="mt-1 p-2 border rounded-md w-full">
      <button type="button" id="fetchDataBtn"
        class="text-white bg-blue-700 hover:bg-blue-800 font-medium rounded-lg text-sm px-4 py-2 mt-2">
        Fetch Data
      </button>
    </div>

    <table id="mealTable" class="w-full text-sm text-left rtl:text-right text-gray-500">
      <thead class="text-xs text-gray-700 uppercase bg-gray-50">
        <tr>
          <th scope="col" class="px-6 py-3">
            Meal Name
          </th>
          <th scope="col" class="px-6 py-3">
            Calorie (kcal)
          </th>
          <th scope="col" class="px-6 py-3">
            Protein (g)
          </th>
          <th scope="col" class="px-6 py-3">
            Time
          </th>
        </tr>
      </thead>
      <tbody>
        <% if (meals && meals.length> 0) { %>
          <% meals.forEach(meal=> { %>
            <tr class="bg-white border-b">
              <td class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap">
                <%= meal.meal_name %>
              </td>
              <td class="px-6 py-4">
                <%= meal.calorie %>
              </td>
              <td class="px-6 py-4">
                <%= meal.protein %>
              </td>
              <td class="px-6 py-4">
                <%= new Date(meal.time).toLocaleString('en-US', { weekday: 'short', month: 'short', day: 'numeric', year: 'numeric', hour: 'numeric', minute: 'numeric', second: 'numeric', timeZoneName: 'short' }) %>
              </td>
            </tr>
            <% }); %>
              <% } else { %>
                <tr>
                  <td colspan="4">No meals found.</td>
                </tr>
                <% } %>
      </tbody>
    </table>
  </div>


  <!-- table ends here -->

  <script src="index.js"></script>

  <script>

    let input = document.querySelector("#searchfooditem");
    let calorieCount = document.querySelector("#calorie");
    let proteinCount = document.querySelector("#protein");
    let foodItemName = document.querySelector("#foodItemName")
    let calorieSearchBtn = document.getElementById("calorieSearchBtn");
    let usermeal = document.getElementById("usermeal");
    user_name.value = usermeal.innerHTML;
    const selectedDate = new Date().toISOString().split('T')[0]; // Example: '2022-03-01'

    function validateForm() {
      // Get the values from the form
      var calorie = parseFloat(document.getElementById("calorie").value);
      var protein = parseFloat(document.getElementById("protein").value);

      // Client-side validation
      if (calorie <= 0) {
        // Show an alert
        alert("Calorie count must be greater than zero.");
      } else {
        // If validation passes, you can submit the form or perform other actions
        document.getElementById("myForm").submit();
      }
    }


    function getData() {
      var query = input.value;
      $.ajax({
        method: 'GET',
        url: 'https://api.calorieninjas.com/v1/nutrition?query=' + encodeURIComponent(query),
        headers: { 'X-Api-Key': '+LvNaxYhtMvMytLY0e3pvg==bQtBnir086pATb2i' },
        contentType: 'application/json',
        success: function (result) {
          console.log(result);

          if (result.items && result.items.length > 0) {
            var caloriesValue = result.items[0].calories;
            var proteinValue = result.items[0].protein_g;
            console.log('Calories:', caloriesValue);
            console.log('Proteins:', proteinValue);
            calorieCount.value = caloriesValue;
            proteinCount.value = proteinValue;
            foodItemName.value = query;

          } else {
            console.error('No items found in the API response');
          }
        },
        error: function ajaxError(jqXHR) {
          console.error('Error: ', jqXHR.responseText);
        }
      });
    }

    calorieSearchBtn.addEventListener("click", () => {
      getData();
    });

    function preventBack() { window.history.forward(); } setTimeout("preventBack()", 0); window.onunload = function () { null };

    document.addEventListener('DOMContentLoaded', function () {
      const fetchDataBtn = document.getElementById('fetchDataBtn');
      const datepicker = document.getElementById('datepicker');

      // Attach the fetchData function to the button click event
      fetchDataBtn.addEventListener('click', fetchData);

      function fetchData() {
        // Get the selected date from the date input
        const selectedDate = datepicker.value;

        // Send an AJAX request to the server with the selected date
        fetch(`/fetchData?selectedDate=${selectedDate}`)
          .then(response => response.json())
          .then(data => {
            // Update the table with the received data
            updateTable(data);
          })
          .catch(error => {
            console.error('Error fetching data:', error);
          });
      }

      function updateTable(data) {
        const tableBody = document.querySelector('#mealTable tbody');
        tableBody.innerHTML = ''; // Clear existing table content

        if (data && data.length > 0) {
          data.forEach(meal => {
            const row = document.createElement('tr');
            row.classList.add('bg-white', 'border-b');

            const columns = ['meal_name', 'calorie', 'protein', 'time'];
            columns.forEach(column => {
              const cell = document.createElement('td');
              cell.classList.add('px-6', 'py-4', 'whitespace-nowrap');
              cell.textContent = meal[column];
              row.appendChild(cell);
            });

            tableBody.appendChild(row);
          });
        } else {
          const row = document.createElement('tr');
          const cell = document.createElement('td');
          cell.colSpan = 4;
          cell.textContent = 'No meals found.';
          row.appendChild(cell);
          tableBody.appendChild(row);
        }
      }
    });

    document.addEventListener('DOMContentLoaded', function () {
  // ... (Your existing code)

  const updateDetailsBtn = document.getElementById('updateDetailsBtn');

  updateDetailsBtn.addEventListener('click', () => {
    const newWeight = prompt("Enter new weight:");
    const newHeight = prompt("Enter new height:");

    // Send an AJAX request to the server to update user details
    $.ajax({
      method: 'POST',
      url: '/updateDetails',
      data: { newWeight, newHeight },
      success: function (result) {
        // Redirect or handle success as needed
        console.log('User details updated successfully');
      },
      error: function (jqXHR) {
        console.error('Error updating user details:', jqXHR.responseText);
        // Handle error as needed
      }
    });
  });
});


  </script>

</body>

</html>